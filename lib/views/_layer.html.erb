<%- layer = LayerOptions.new layer -%>

<%- content_for :script do -%>
<script type="text/javascript" charset="utf-8">
  var pkwde = pkwde || {};
  pkwde.layer = pkwde.layer || {};
  (function($) {
    <%= layer.ajax_callback_function_name %> = function (responseText, textStatus, XMLHttpRequest) {
      // TODO aus der Form eine Ajax-Form erstellen...
      if(textStatus == "success"){
        // suche nach cancel button
        var buttons = {};
        var form = $("form", $(this));
        
        // Erstetzen des HTML-Cancel-Button durch Javascript-Button des Layers
        var cancelButton = $(".cancel_button", this);
        if(cancelButton.length > 0){
          cancelButton.hide();
          buttons[cancelButton.text()] = pkwde.layer.closeFunction;
        }
        // Erstetzen des Submit-Buttons durch Javascript-Button des Layers 
        var submitButton = $(".submit_button", this);
        if(submitButton.length > 0){
          submitButton.hide();
          buttons[submitButton.val()] = <%= layer.submit_form_function_name %>(form);
        }
        
        $("<%= layer.layer_selector %>").dialog( "option", {buttons: buttons } );
        $("<%= layer.layer_selector %>").trigger("ajaxComplete");
        
        <%- if layer.use_ajax -%>
        // remove standard action on submit
        form.submit(<%= layer.submit_form_function_name %>(form));
        <%- end -%>
      }else{//etwas lief schief
        $("<%= layer.layer_selector %>").trigger("ajaxError");
      }
    };
    
    <%= layer.submit_form_function_name %> = function(f) {
      var form = f;
      return function(event) {
        if(event){
          event.preventDefault();
        }
        <%- if layer.use_ajax -%>
          $.post(form.attr("action"), form.serialize(), null, "script");
        <%- else -%>
          form.submit();
        <%- end -%>
      };
    };
    
    <%= layer.ajax_call_function_name %> = function(event, ui) {
      <%= "#{layer.dialog_callbacks[:open]}(event, ui);" if layer.dialog_callbacks[:open] %>
      <%- layer.dialog_callbacks[:open] = layer.ajax_call_function_name -%>
      $("<%= layer.layer_selector %>").load("<%= layer.url %>", <%= layer.ajax_callback_function_name %>);
    };
    
    pkwde.layer.closeFunction = function(event, ui) {
      <%= "#{layer.dialog_callbacks[:close]}(event, ui);" if layer.dialog_callbacks[:close] %>
      <%- layer.dialog_callbacks[:close] = "pkwde.layer.closeFunction" %>
      $("<%= layer.layer_selector %>").dialog("destroy");
    };
    
    <%= layer.create_window_function_name %> = function() {
      $("<%= layer.layer_selector %>").dialog(<%= layer.to_json %>);
    };
    
    <%= layer.initialize_layer_function_name %> = function(){
      $("<%= layer.trigger_selector %>").click(function() {
        <%= layer.create_window_function_name %>();
        return false;
      });
      $("<%= layer.trigger_selector %>").attr("href", "#");
    };

    //ready
    $(document).ready(function() {
      <%= layer.initialize_layer_function_name %>();
    });
    
  })(jQuery);
</script>
<%- end -%>
